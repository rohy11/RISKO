<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Risk Tolerance Assessment</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: #f0f2f5;
      color: #333;
    }
    h1 {
      color: #2c3e50;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      color: #666;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 24px;
      margin: 5px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #2980b9;
    }
    #textInput {
      padding: 12px;
      font-size: 16px;
      width: 250px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 25px;
      outline: none;
    }
    #chatOutput {
      margin: 20px auto;
      max-width: 700px;
      min-height: 300px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: flex;
      flex-direction: column-reverse; /* New messages at top */
      overflow-y: auto;
    }
    .message {
      margin: 8px 0;
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .user {
      background: #3498db;
      color: white;
      align-self: flex-end;
    }
    .bot {
      background: #ecf0f1;
      color: #333;
      align-self: flex-start;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
</head>
<body>
  <h1>Risk Tolerance Assessment</h1>
  <p>Click "Start" and I’ll guide you through your assessment with voice or text.</p>
  <button id="startBtn">Start</button>
  <button id="voiceBtn">Speak</button>
  <br>
  <input type="text" id="textInput" placeholder="Type your answer here">
  <button id="sendBtn">Send</button>
  <div id="chatOutput"></div>

  <script>
    const synth = window.speechSynthesis;
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = false;
    recognition.lang = 'en-US';

    let model;
    let step = 0;
    let comraScore = null;
    let priorities = [];
    const questions = [
      "Let’s dive in! Have you taken the Color of Money Risk Analysis? Give me your score (0-100) or say 'No'.",
      "Cool, now priorities. Rank 'Protecting principal and avoiding losses' from 1 to 8.",
      "Next: 'Maximizing my income.' Rank it 1-8.",
      "'Minimizing income taxes.' What’s your rank, 1-8?",
      "'Receiving a better return on my assets.' Rank it 1-8.",
      "Halfway! 'Leaving a legacy'—rank it 1-8.",
      "'Tax-advantaged income in retirement.' Rank it 1-8.",
      "Almost there: 'Long-term care costs.' Rank 1-8.",
      "Last one: 'Saving for a particular goal.' Rank it 1-8.",
      "Here’s what I’ve got. Is this correct? Say 'Yes' or 'No'."
    ];

    // Load NLP model
    async function loadModel() {
      model = await use.load();
      addMessage('Hey, I’m ready! Hit "Start" to kick things off.');
    }
    loadModel();

    // Display message
    function addMessage(text, isUser = false) {
      const chat = document.getElementById('chatOutput');
      const msg = document.createElement('div');
      msg.className = 'message ' + (isUser ? 'user' : 'bot');
      msg.textContent = text;
      chat.insertBefore(msg, chat.firstChild); // Insert at top
      chat.scrollTop = 0; // Scroll to top
      if (!isUser) speak(text);
    }

    // Speak function
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      synth.speak(utterance);
    }

    // Process input with NLP
    async function processInput(input) {
      addMessage(input, true);
      if (!model) {
        addMessage('Hold on, I’m still warming up!');
        return;
      }

      const embeddings = await model.embed([input.toLowerCase(), 'yes', 'no', '0-100']);
      const inputEmb = embeddings.slice([0, 0], [1, -1]);
      const yesEmb = embeddings.slice([1, 0], [1, -1]);
      const noEmb = embeddings.slice([2, 0], [1, -1]);
      const numEmb = embeddings.slice([3, 0], [1, -1]);

      const yesSim = tf.matMul(inputEmb, yesEmb, false, true).dataSync()[0];
      const noSim = tf.matMul(inputEmb, noEmb, false, true).dataSync()[0];
      const numSim = tf.matMul(inputEmb, numEmb, false, true).dataSync()[0];

      if (step === 0) { // COMRA Score
        if (noSim > 0.9 || input.toLowerCase().includes('no')) {
          comraScore = 'Not provided';
          addMessage('No worries, let’s jump to priorities.');
          step++;
          setTimeout(() => addMessage(questions[step]), 200); // Faster
        } else if (numSim > 0.8 || (!isNaN(input) && input >= 0 && input <= 100)) {
          const score = parseInt(input);
          if (score >= 0 && score <= 100) {
            comraScore = score;
            addMessage(`Nice, your score’s ${score}. On to priorities!`);
            step++;
            setTimeout(() => addMessage(questions[step]), 200);
          } else {
            addMessage('Need a number 0-100 or "No". Try again!');
          }
        } else {
          addMessage('Score between 0-100 or "No", please!');
        }
      } else if (step >= 1 && step <= 8) { // Priorities
        const rank = parseInt(input);
        if (!isNaN(rank) && rank >= 1 && rank <= 8 && !priorities.includes(rank)) {
          priorities.push(rank);
          addMessage(`Locked in ${rank}. Next!`);
          step++;
          if (step <= 8) {
            setTimeout(() => addMessage(questions[step]), 200);
          } else {
            const summary = `Here’s your rundown: COMRA: ${comraScore}, Priorities: ` +
              questions.slice(1, 9).map((q, i) => `${i + 1}. ${q.split("'")[1]}: ${priorities[i]}`).join(', ');
            addMessage(summary);
            setTimeout(() => addMessage(questions[step]), 200);
          }
        } else {
          addMessage('Unique number 1-8, please! What’s your rank?');
        }
      } else if (step === 9) { // Confirmation
        if (yesSim > 0.9 || input.toLowerCase().includes('yes')) {
          addMessage('Sweet! All done—thanks for chatting!');
          step++;
        } else if (noSim > 0.9 || input.toLowerCase().includes('no')) {
          addMessage('No prob, restart with "Start" to tweak it.');
          step++;
        } else {
          addMessage('"Yes" or "No" to wrap up—your call!');
        }
      }
    }

    // Start button
    document.getElementById('startBtn').addEventListener('click', () => {
      step = 0;
      priorities = [];
      comraScore = null;
      document.getElementById('chatOutput').innerHTML = '';
      addMessage('Hey there! I’m your AI buddy for this risk assessment. Let’s roll!');
      setTimeout(() => addMessage(questions[0]), 200);
    });

    // Voice button
    document.getElementById('voiceBtn').addEventListener('click', () => {
      recognition.start();
      addMessage('Go for it—I’m listening!');
    });

    recognition.onresult = (event) => {
      const userInput = event.results[0][0].transcript;
      processInput(userInput);
    };

    recognition.onerror = () => {
      addMessage('Whoops, missed that. Try again?');
    };

    // Text input and Send button
    document.getElementById('sendBtn').addEventListener('click', () => {
      const userInput = document.getElementById('textInput').value.trim();
      if (userInput) {
        processInput(userInput);
        document.getElementById('textInput').value = '';
      } else {
        addMessage('Type something so we can keep going!');
      }
    });

    document.getElementById('textInput').addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        document.getElementById('sendBtn').click();
      }
    });
  </script>
</body>
</html>

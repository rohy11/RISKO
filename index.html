<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Tolerance Assessment</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298); /* Modern gradient */
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chatContainer {
      flex: 1;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      overflow-y: auto; /* Scrollable chat */
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      padding: 12px 18px;
      border-radius: 15px;
      max-width: 75%;
      font-size: 16px;
      line-height: 1.4;
      animation: fadeIn 0.3s ease-in; /* Subtle animation */
    }
    .user {
      background: #4a90e2;
      color: white;
      align-self: flex-end;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .bot {
      background: #f1f4f8;
      color: #2c3e50;
      align-self: flex-start;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    #inputArea {
      max-width: 900px;
      margin: 0 auto 20px auto;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      border-radius: 0 0 20px 20px;
    }
    #textInput {
      flex: 1;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      background: #e9ecef;
      color: #2c3e50;
      outline: none;
      margin-right: 15px;
      transition: background 0.3s;
    }
    #textInput:focus {
      background: #fff;
      box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
    }
    button {
      padding: 12px 25px;
      font-size: 16px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      background: #357abd;
      transform: scale(1.05);
    }
    button:active {
      transform: scale(0.95);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
</head>
<body>
  <div id="chatContainer"></div>
  <div id="inputArea">
    <input type="text" id="textInput" placeholder="Type your answer here...">
    <button id="voiceBtn">Speak</button>
    <button id="sendBtn">Send</button>
  </div>

  <script>
    const synth = window.speechSynthesis;
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = false;
    recognition.lang = 'en-US';

    let model;
    let step = 0;
    let comraScore = null;
    let priorities = [];
    const questions = [
      "Hey there! Let’s dive into your risk tolerance. Have you taken the Color of Money Risk Analysis? Give me your score (0-100) or say 'No'.",
      "Awesome, now let’s rank your priorities. For 'Protecting principal and avoiding losses,' pick a rank from 1 to 8.",
      "Next up: 'Maximizing my income.' Rank it 1-8.",
      "Moving along: 'Minimizing income taxes.' What’s your rank, 1-8?",
      "'Receiving a better return on my assets.' Rank it 1-8.",
      "Halfway there! 'Leaving a legacy'—rank it 1-8.",
      "'Tax-advantaged income in retirement.' Rank it 1-8.",
      "Almost done: 'Long-term care costs.' Rank 1-8.",
      "Last one: 'Saving for a particular goal.' Rank it 1-8.",
      "Here’s your summary. Does this look right? Say 'Yes' or 'No'."
    ];

    // Load NLP model and start automatically
    async function loadModel() {
      model = await use.load();
      addMessage('Hey! I’m your AI assistant, ready to guide you through your risk assessment.');
      setTimeout(() => addMessage(questions[0]), 200);
    }
    loadModel();

    // Display message
    function addMessage(text, isUser = false) {
      const chat = document.getElementById('chatContainer');
      const msg = document.createElement('div');
      msg.className = 'message ' + (isUser ? 'user' : 'bot');
      msg.textContent = text;
      chat.appendChild(msg); // Adds to bottom
      chat.scrollTop = chat.scrollHeight; // Auto-scroll to latest
    }

    // Speak function
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      synth.speak(utterance);
    }

    // Process input with NLP
    async function processInput(input) {
      addMessage(input, true);
      if (!model) {
        addMessage('Just a sec, I’m still loading!');
        return;
      }

      const embeddings = await model.embed([input.toLowerCase(), 'yes', 'no', '0-100']);
      const inputEmb = embeddings.slice([0, 0], [1, -1]);
      const yesEmb = embeddings.slice([1, 0], [1, -1]);
      const noEmb = embeddings.slice([2, 0], [1, -1]);
      const numEmb = embeddings.slice([3, 0], [1, -1]);

      const yesSim = tf.matMul(inputEmb, yesEmb, false, true).dataSync()[0];
      const noSim = tf.matMul(inputEmb, noEmb, false, true).dataSync()[0];
      const numSim = tf.matMul(inputEmb, numEmb, false, true).dataSync()[0];

      if (step === 0) { // COMRA Score
        if (noSim > 0.9 || input.toLowerCase().includes('no')) {
          comraScore = 'Not provided';
          addMessage('Cool, let’s skip that and jump to priorities.');
          step++;
          setTimeout(() => addMessage(questions[step]), 200);
        } else if (numSim > 0.8 || (!isNaN(input) && input >= 0 && input <= 100)) {
          const score = parseInt(input);
          if (score >= 0 && score <= 100) {
            comraScore = score;
            addMessage(`Got it, your score’s ${score}. Let’s move to priorities!`);
            step++;
            setTimeout(() => addMessage(questions[step]), 200);
          } else {
            addMessage('I need a number 0-100 or "No". What’s your answer?');
          }
        } else {
          addMessage('Please give me a score 0-100 or "No".');
        }
      } else if (step >= 1 && step <= 8) { // Priorities
        const rank = parseInt(input);
        if (!isNaN(rank) && rank >= 1 && rank <= 8 && !priorities.includes(rank)) {
          priorities.push(rank);
          addMessage(`Locked in ${rank}. Onward!`);
          step++;
          if (step <= 8) {
            setTimeout(() => addMessage(questions[step]), 200);
          } else {
            const summary = `Here’s your rundown: COMRA: ${comraScore}, Priorities: ` +
              questions.slice(1, 9).map((q, i) => `${i + 1}. ${q.split("'")[1]}: ${priorities[i]}`).join(', ');
            addMessage(summary);
            setTimeout(() => addMessage(questions[step]), 200);
          }
        } else {
          addMessage('Need a unique number 1-8. What’s your rank?');
        }
      } else if (step === 9) { // Confirmation
        if (yesSim > 0.9 || input.toLowerCase().includes('yes')) {
          addMessage('Awesome! We’re all set—thanks for the chat!');
          step++;
        } else if (noSim > 0.9 || input.toLowerCase().includes('no')) {
          addMessage('No worries, refresh to restart and tweak it.');
          step++;
        } else {
          addMessage('Just need a "Yes" or "No". What do you say?');
        }
      }
    }

    // Voice button
    document.getElementById('voiceBtn').addEventListener('click', () => {
      recognition.start();
      addMessage('I’m listening—go ahead!');
    });

    recognition.onresult = (event) => {
      const userInput = event.results[0][0].transcript;
      processInput(userInput);
    };

    recognition.onerror = () => {
      addMessage('Oops, didn’t catch that. Try again?');
    };

    // Text input and Send button
    document.getElementById('sendBtn').addEventListener('click', () => {
      const userInput = document.getElementById('textInput').value.trim();
      if (userInput) {
        processInput(userInput);
        document.getElementById('textInput').value = '';
      } else {
        addMessage('Type something to keep us rolling!');
      }
    });

    document.getElementById('textInput').addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        document.getElementById('sendBtn').click();
      }
    });
  </script>
</body>
</html>
